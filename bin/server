#!/usr/bin/env bash
# -*- bash -*-
#
#
cmd="$1"
set -u -e -o pipefail

export PORT=4567
export PID="/tmp/www_app/thin.pid"
export LOG="/tmp/www_app/log.txt"
export RACK_ENV="production"

dir="$(pwd)"

if [[ "$cmd" == "start" ]]; then

  if [[ -f "$PID" && -s "$PID" ]]; then
    $dir/bin/server stop
  fi

  echo "--- resetting files: $cmd"

  cd /tmp
  rm -rf www_app
  mkdir -p www_app/tmp
fi

if [[ "$cmd" != "stop" ]]; then
  echo "--- Public files: $cmd"
  cd /tmp/www_app
  $dir/bin/www_app Public
fi


cd $dir
bundle exec thin -d -c /tmp/www_app -l $LOG --pid $PID -p $PORT -e production -R $dir/specs/lib/config.ru $@


cd /tmp/www_app

if [[ "$@" == *start* ]]
then
  sleep 0.5
  if [[ -f "$PID" ]]; then
    echo "Started server: PORT: $PORT PID: $(cat $PID)"
    sleep 1.0
    cat $LOG
  else
    cat $LOG 1>&2
    exit 1
  fi
fi


